# Cimian MSI Product ID Fix

## Problem Analysis

The issue was that every Cimian installation appeared as a separate program in Windows "Programs and Features" because the MSI configuration was using a wildcard Product ID (`Product Id="*"`). This caused WiX to generate a new random GUID for each build, making Windows treat each installation as a completely different product.

### Visual Evidence
The screenshot showed multiple "Cimian" entries with identical sizes but different installation dates, confirming that each installation was getting a unique Product ID.

### Root Cause
In `packages/CimianTools/build/msi.wxs`, line 11 had:
```xml
<Product Id="*"
```

This wildcard tells WiX to generate a random GUID for each build, which creates the duplicate program entries.

## Solution Implemented

### 1. Fixed Product ID
Changed the wildcard to a consistent GUID:
```xml
<Product Id="9127064A-3536-42A1-BDE4-131AA5DBE458"
```

### 2. Updated Maximum Upgrade Version
Increased the maximum version in the upgrade configuration from `25.2.14` to `99.99.99` to ensure the upgrade mechanism works for all future versions:
```xml
<UpgradeVersion OnlyDetect="no"
                Property="OLDPRODUCTS"
                Minimum="0.0.0"
                IncludeMinimum="yes"
                Maximum="99.99.99"
                IncludeMaximum="no" />
```

### 3. Updated Intune Uninstall Command
Fixed the uninstall command in `provisioning/scripts/Create-IntuneApps.ps1` to use the ProductCode instead of UpgradeCode:
```powershell
uninstallCommandLine = "msiexec /x {9127064A-3536-42A1-BDE4-131AA5DBE458} /quiet /norestart"
```

### 4. Created Cleanup Script
Created `packages/CimianTools/scripts/Remove-DuplicateCimian.ps1` to help clean up existing duplicate installations before deploying the new MSI.

## Impact and Benefits

### Immediate Benefits
- **Single Program Entry**: Future installations will appear as one "Cimian" entry in Programs and Features
- **Proper Upgrades**: MSI upgrade mechanism will work correctly, automatically removing old versions
- **Consistent Detection**: Intune and other deployment tools will properly detect and manage the installation
- **Cleaner System**: No more accumulation of duplicate program entries

### Deployment Strategy

#### For Clean Systems (New Installations)
1. Build new MSI with fixed Product ID
2. Deploy normally via Intune or manual installation
3. Enjoy proper upgrade behavior going forward

#### For Systems with Existing Duplicates
1. **Option A - Clean Slate (Recommended)**:
   - Run `Remove-DuplicateCimian.ps1` script as administrator
   - Deploy new MSI with fixed Product ID
   
2. **Option B - Gradual Migration**:
   - Deploy new MSI alongside existing installations
   - Old installations will remain but new ones will behave correctly
   - Manually remove old entries over time

## Technical Details

### Why This Fix Works
- **MSI Product Rules**: Windows identifies MSI packages by their Product ID
- **Same Product ID = Same Product**: Multiple installations with the same Product ID are treated as upgrades/updates
- **Upgrade Mechanism**: MSI automatically handles removing old versions when Product IDs match and UpgradeCode is consistent
- **Registry Consistency**: Windows registry entries will be consistent across installations

### Files Modified
1. `packages/CimianTools/build/msi.wxs` - Fixed Product ID and upgrade version range
2. `provisioning/scripts/Create-IntuneApps.ps1` - Fixed uninstall command
3. `packages/CimianTools/scripts/Remove-DuplicateCimian.ps1` - New cleanup script

### Compatibility
- **Backward Compatible**: New MSI can be installed on systems with old installations
- **Forward Compatible**: All future versions will use the same Product ID
- **Cross-Architecture**: Both x64 and ARM64 MSIs will use the same Product ID (appropriate for this scenario)

## Validation Steps

### Before Deployment
1. Verify MSI builds successfully with fixed Product ID
2. Test installation on clean system
3. Test upgrade from old installation to new installation
4. Verify only one program entry appears in Programs and Features

### After Deployment
1. Check Programs and Features for single "Cimian" entry
2. Verify Intune detection rules work correctly
3. Test future upgrade installations
4. Monitor for any installation issues

## Future Considerations

### Version Management
- Always increment the Version number in MSI builds
- Keep the Product ID consistent: `9127064A-3536-42A1-BDE4-131AA5DBE458`
- Keep the UpgradeCode consistent: `d61005bf-a182-4583-810d-8c33b056b8be`

### Package Generation
- New pkginfo files generated by `makepkginfo` will automatically include the correct ProductCode
- Old pkginfo files in the deployment folder may reference old Product IDs but this won't affect new deployments

This fix ensures that Cimian behaves like a proper enterprise application with clean upgrade paths and system management compatibility.
