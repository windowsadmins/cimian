<?xml version="1.0"?>
<Wix xmlns="http://wixtoolset.org/schemas/v4/wxs">

  <Package
    Name="Gorilla"
    Version="1.0.0"
    Manufacturer="Gorilla"
    UpgradeCode="d61005BF-A182-4583-810D-8C33B056B8BE">

    <Media Id="1" Cabinet="product.cab" EmbedCab="yes" CompressionLevel="mszip" />

    <!-- Directory Structure -->
    <StandardDirectory Id="ProgramFilesFolder">
      <Directory Id="INSTALLFOLDER" Name="Gorilla">
        <Directory Id="BIN" Name="bin">
          <Component Id="GorillaBinaries" Guid="47855CCD-7EAB-464C-A795-26091DE8B83A">
            <File Id="GorillaImportExe" Source="bin\gorillaimport.exe" />
            <File Id="MakeCatalogsExe" Source="bin\makecatalogs.exe" />
            <File Id="MakePkgInfoExe" Source="bin\makepkginfo.exe" />
            <File Id="ManagedSoftwareUpdateExe" Source="bin\managedsoftwareupdate.exe" />
            <File Id="ManifestUtilExe" Source="bin\manifestutil.exe" />
            <Environment Id="PATH_VAR" Name="PATH" Value="[BIN]" Permanent="no" Part="last" Action="set" System="yes" />
          </Component>
        </Directory>
        <Directory Id="CONFIGDIR" Name="config">
          <Component Id="ConfigComponent" Guid="4882D10A-47BF-48AE-8D00-50EA2C9897EC">
            <File Id="ConfigYamlFile" Source="build\config.yaml" />
          </Component>
        </Directory>
      </Directory>
    </StandardDirectory>

    <!-- Install Execute Sequence -->
    <InstallExecuteSequence>
      <Custom Action="CreateScheduledTask" After="InstallFiles" Condition="NOT Installed OR REINSTALL" />
      <Custom Action="DeleteScheduledTask" Before="RemoveFiles" Condition="Installed" />
    </InstallExecuteSequence>

    <!-- Custom Actions -->
    <CustomAction Id="CreateScheduledTask"
                  Directory="SystemFolder"
                  ExeCommand="SCHTASKS.EXE /CREATE /SC MINUTE /MO 60 /TN &quot;Gorilla&quot; /TR &quot;&quot;[BIN]managedsoftwareupdate.exe&quot;&quot; /RU &quot;NT AUTHORITY\SYSTEM&quot; /RL HIGHEST"
                  Execute="deferred"
                  Return="check"
                  Impersonate="no" />

    <CustomAction Id="DeleteScheduledTask"
                  Directory="SystemFolder"
                  ExeCommand="SCHTASKS.EXE /DELETE /F /TN &quot;Gorilla&quot;"
                  Execute="deferred"
                  Return="ignore"
                  Impersonate="no" />

    <!-- Feature Definition -->
    <Feature Id="DefaultFeature" Level="1">
      <ComponentRef Id="GorillaBinaries" />
      <ComponentRef Id="ConfigComponent" />
    </Feature>

  </Package>
</Wix>
