<?xml version="1.0" encoding="UTF-8"?>

<!-- WiX Installer XML for Cimian Application -->
<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi"
     xmlns:util="http://schemas.microsoft.com/wix/UtilExtension">

  <?ifndef ProductVersion?>
    <?define ProductVersion = "0.0.0"?>
  <?endif?>

  <!-- Product Definition -->
  <Product Id="9127064A-3536-42A1-BDE4-131AA5DBE458"
           UpgradeCode="d61005bf-a182-4583-810d-8c33b056b8be"
           Name="Cimian"
           Version="$(var.ProductVersion)"
           Manufacturer="Cimian"
           Language="1033">

    <!-- Package Information -->
    <Package InstallerVersion="500"
             Compressed="yes"
             Comments="Windows Installer Package"
             InstallScope="perMachine"
             Platform="x64" />

    <!-- Search for the config file -->
    <Property Id="CONFIGFILE">
      <DirectorySearch Id="ManagedInstallsDirSearch" Path="[CommonAppDataFolder]ManagedInstalls">
        <FileSearch Id="ConfigFileSearch" Name="Config.yaml" />
      </DirectorySearch>
    </Property>

    <!-- Major Upgrade Settings -->
    <Upgrade Id="d61005bf-a182-4583-810d-8c33b056b8be">
      <UpgradeVersion OnlyDetect="no"
                      Property="OLDPRODUCTS"
                      Minimum="0.0.0"
                      IncludeMinimum="yes"
                      Maximum="99.99.99"
                      IncludeMaximum="no" />
    </Upgrade>

    <!-- Media Definition -->
    <Media Id="1"
           Cabinet="product.cab"
           EmbedCab="yes" />

    <!-- Directory Structure -->
    <Directory Id="TARGETDIR" Name="SourceDir">

      <!-- Program Files Directory for 64-bit Systems -->
      <Directory Id="ProgramFiles64Folder">
        <Directory Id="INSTALLDIR" Name="Cimian">

          <!-- Components and Files -->
          <Component Id="Binary1" Guid="47855CCD-7EAB-464C-A795-26091DE8B83A" Win64="yes">
            <File Id="BinaryFile1" Source="$(var.BIN_DIR)\cimiimport.exe" KeyPath="yes" />
          </Component>
          <Component Id="Binary2" Guid="67855CDD-8EAB-564C-B795-26091FE9B83A" Win64="yes">
            <File Id="BinaryFile2" Source="$(var.BIN_DIR)\makecatalogs.exe" KeyPath="yes" />
          </Component>
          <Component Id="Binary3" Guid="77855CDE-9FAB-464D-C795-26091DE8B83A" Win64="yes">
            <File Id="BinaryFile3" Source="$(var.BIN_DIR)\makepkginfo.exe" KeyPath="yes" />
          </Component>
          <Component Id="Binary4" Guid="87855CDE-AFAB-564D-D795-26091FE9B83A" Win64="yes">
            <File Id="BinaryFile4" Source="$(var.BIN_DIR)\managedsoftwareupdate.exe" KeyPath="yes" />
          </Component>
          <Component Id="Binary5" Guid="97855CDE-BFAB-664D-E795-26091DE8B83A" Win64="yes">
            <File Id="BinaryFile5" Source="$(var.BIN_DIR)\manifestutil.exe" KeyPath="yes" />
          </Component>
          <Component Id="Binary6" Guid="AF855CDE-1234-5678-9ABC-26091DE9B83B" Win64="yes">
            <File Id="BinaryFile6" Source="$(var.BIN_DIR)\cimipkg.exe" KeyPath="yes" />
          </Component>

          <!-- CimianStatus GUI for bootstrap progress -->
          <Component Id="Binary7" Guid="BF855CDE-1234-5678-9ABC-26091DE9B83C" Win64="yes">
            <File Id="BinaryFile7" Source="$(var.BIN_DIR)\cimistatus.exe" KeyPath="yes" />
          </Component>

          <!-- CimianWatcher service for responsive bootstrap monitoring -->
          <Component Id="Binary8" Guid="CF855CDE-1234-5678-9ABC-26091DE9B83D" Win64="yes">
            <File Id="BinaryFile8" Source="$(var.BIN_DIR)\cimiwatcher.exe" KeyPath="yes" />
          </Component>

          <!-- Component to Modify PATH Environment Variable -->
          <Component Id="SetPathComponent" Guid="A5F2C571-89DF-4C71-967F-EC9D3EF4CDD0" Win64="yes">
            <RegistryValue Root="HKLM" Key="Software\Cimian" Name="InstallPath" Value="[INSTALLDIR]" Type="string" KeyPath="yes" />
            <Environment Id="UpdatePath" Name="PATH" Value="[INSTALLDIR]" Permanent="no" Part="last" Action="set" Separator=";" System="yes" />
          </Component>

        </Directory>
      </Directory>

      <!-- Common Application Data Directory -->
      <Directory Id="CommonAppDataFolder">
        <Directory Id="ManagedInstalls" Name="ManagedInstalls">

          <!-- Component for Configuration File (config.yaml) -->
          <Component Id="Component_Config" Guid="D4E5F6A7-B8C9-0D1E-2F3A-4B5C6D7E8F9A" Win64="yes">
            <File Id="File_Config" Source="build\config.yaml" KeyPath="yes" />
          </Component>

        </Directory>
      </Directory>

    </Directory>

    <!-- Custom Actions -->
    <SetProperty Id="RunCimiImport"
                 Value="&quot;[INSTALLDIR]cimiimport.exe&quot; --config-auto"
                 Sequence="execute"
                 Before="RunCimiImport">NOT CONFIGFILE</SetProperty>
                 
    <CustomAction Id="RunCimiImport"
                  BinaryKey="WixCA"
                  DllEntry="CAQuietExec64"
                  Execute="deferred"
                  Return="check"
                  Impersonate="no" />

    <!-- Create the regular hourly scheduled task for periodic software checks -->
    <CustomAction Id="CreateScheduledTask"
                  Execute="deferred"
                  Impersonate="no"
                  Return="check"
                  Directory="INSTALLDIR"
                  ExeCommand="[SystemFolder]SCHTASKS.EXE /CREATE /F /SC MINUTE /MO 60 /TN CimianHourlyRun /TR &quot;[INSTALLDIR]managedsoftwareupdate.exe /silent&quot; /RU SYSTEM /RL HIGHEST" />

    <!-- Install and start the CimianWatcher service -->
    <CustomAction Id="InstallCimianWatcherService"
                  Execute="deferred"
                  Impersonate="no"
                  Return="check"
                  Directory="INSTALLDIR"
                  ExeCommand="&quot;[INSTALLDIR]cimiwatcher.exe&quot; install" />

    <CustomAction Id="StartCimianWatcherService"
                  Execute="deferred"
                  Impersonate="no"
                  Return="ignore"
                  Directory="INSTALLDIR"
                  ExeCommand="&quot;[INSTALLDIR]cimiwatcher.exe&quot; start" />

    <!-- Remove the CimianWatcher service on uninstall -->
    <CustomAction Id="StopCimianWatcherService"
                  Execute="deferred"
                  Impersonate="no"
                  Return="ignore"
                  Directory="INSTALLDIR"
                  ExeCommand="&quot;[INSTALLDIR]cimiwatcher.exe&quot; stop" />

    <CustomAction Id="RemoveCimianWatcherService"
                  Execute="deferred"
                  Impersonate="no"
                  Return="ignore"
                  Directory="INSTALLDIR"
                  ExeCommand="&quot;[INSTALLDIR]cimiwatcher.exe&quot; remove" />

    <!-- Remove the scheduled task on uninstall -->
    <CustomAction Id="DeleteScheduledTask"
                  Execute="deferred"
                  Impersonate="no"
                  Return="ignore"
                  Directory="INSTALLDIR"
                  ExeCommand="[SystemFolder]SCHTASKS.EXE /DELETE /F /TN CimianHourlyRun" />

    <!-- Schedule the Custom Actions -->
    <InstallExecuteSequence>
      <Custom Action="RunCimiImport" After="InstallFiles">NOT CONFIGFILE</Custom>
      <!-- Custom Action for Installation -->
      <Custom Action="CreateScheduledTask" After="InstallFiles">NOT REMOVE</Custom>
      <Custom Action="InstallCimianWatcherService" After="CreateScheduledTask">NOT REMOVE</Custom>
      <Custom Action="StartCimianWatcherService" After="InstallCimianWatcherService">NOT REMOVE</Custom>

      <!-- Custom Action for Uninstallation -->
      <Custom Action="StopCimianWatcherService" Before="RemoveFiles">REMOVE="ALL"</Custom>
      <Custom Action="RemoveCimianWatcherService" After="StopCimianWatcherService">REMOVE="ALL"</Custom>
      <Custom Action="DeleteScheduledTask" Before="RemoveFiles">REMOVE="ALL"</Custom>
      <RemoveExistingProducts After="InstallInitialize" />
    </InstallExecuteSequence>

    <!-- Feature Definition -->
    <Feature Id="DefaultFeature" Level="1">
      <ComponentRef Id="Binary1" />
      <ComponentRef Id="Binary2" />
      <ComponentRef Id="Binary3" />
      <ComponentRef Id="Binary4" />
      <ComponentRef Id="Binary5" />
      <ComponentRef Id="Binary6" />
      <ComponentRef Id="Binary7" />
      <ComponentRef Id="Binary8" />
      <ComponentRef Id="SetPathComponent" />
      <ComponentRef Id="Component_Config" />
    </Feature>

  </Product>

</Wix>
